name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build services
      run: |
        docker build -t rating-service:latest -f cmd/rating/Dockerfile .
        docker build -t gateway-service:latest -f cmd/gateway/Dockerfile .

    - name: Test Docker images
      run: |
        echo "Testing Docker images..."
        docker images

  healthcheck:
    name: Health Check Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Start services
      run: |
        docker-compose up -d
        sleep 10

    - name: Check running containers
      run: |
        docker-compose ps
        docker ps -a

    - name: Wait for services
      run: |
        chmod +x wait-for.sh
        chmod +x wait-script.sh
        ./wait-for.sh -t 30 postgres:5432 -- echo "PostgreSQL is ready"
        WAIT_PORTS="8050,8080" ./wait-script.sh

    - name: Verify health endpoints
      run: |
        curl -f http://localhost:8050/manage/health || exit 1
        curl -f http://localhost:8080/manage/health || exit 1
        echo "All health checks passed!"

    - name: Cleanup
      if: always()
      run: docker-compose down