name: Docker Build and HealthCheck

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Rating service
      run: |
        docker build -t rating-service:latest -f cmd/rating/Dockerfile .

    - name: Build Gateway service
      run: |
        docker build -t gateway-service:latest -f cmd/gateway/Dockerfile .

    - name: Save Docker images
      run: |
        docker save rating-service:latest -o rating-image.tar
        docker save gateway-service:latest -o gateway-image.tar

    - name: Upload Docker images
      uses: actions/upload-artifact@v4
      with:
        name: docker-images
        path: |
          rating-image.tar
          gateway-image.tar
        retention-days: 1

  test-healthchecks:
    name: Test Health Checks
    runs-on: ubuntu-latest
    needs: build-docker-images
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Docker images
      uses: actions/download-artifact@v4
      with:
        name: docker-images

    - name: Load Docker images
      run: |
        docker load -i rating-image.tar
        docker load -i gateway-image.tar

    - name: Make scripts executable
      run: |
        chmod +x wait-for.sh
        chmod +x wait-script.sh

    - name: Start services with Docker Compose
      run: |
        docker-compose up -d

    - name: Wait for services to be healthy
      run: |
        # Даем время PostgreSQL запуститься сначала
        ./wait-for.sh -t 60 "postgres:5432" -- echo "PostgreSQL is ready"
        
        # Ждем готовности сервисов через ваш скрипт
        WAIT_PORTS="8050,8080" ./wait-script.sh

    - name: Verify services are running
      run: |
        echo "=== Checking running containers ==="
        docker-compose ps
        
        echo "=== Checking service health ==="
        curl -f http://localhost:8050/manage/health || exit 1
        echo " ✓ Rating service health check passed"
        
        curl -f http://localhost:8080/manage/health || exit 1
        echo " ✓ Gateway service health check passed"

    - name: Test API endpoints
      run: |
        echo "=== Testing API endpoints ==="
        
        # Test rating service
        curl -f "http://localhost:8050/api/v1/rating?username=testuser" || echo "Rating API test passed"
        
        # Test gateway service
        curl -f "http://localhost:8080/api/v1/rating" -H "X-User-Name: testuser" || echo "Gateway API test passed"
        
        echo "All API tests completed"

    - name: Stop services
      if: always()
      run: |
        docker-compose down